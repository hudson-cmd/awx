---
- name: Atualizar OpenSSL e compilar OpenSSH 9.8p1 no Rocky Linux 8
  hosts: all
  become: true
  vars:
    openssh_version: "9.8p1"
    src_dir: "/usr/local/src/openssh-src"
    build_dir: "{{ src_dir }}/openssh-{{ openssh_version }}"
    openssh_url: "https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-{{ openssh_version }}.tar.gz"

  tasks:
    - name: Atualizar todos os pacotes do sistema
      package:
        name: "*"
        state: latest

    - name: Instalar OpenSSL 1.1.1 e libs compat
      package:
        name:
          - openssl
          - openssl-devel
          - openssl-libs
          - compat-openssl11
          - compat-openssl11-devel
        state: present

    - name: Verificar versão do OpenSSL após atualização
      command: openssl version
      register: openssl_ver
      changed_when: false

    - name: Mostrar versão do OpenSSL
      debug:
        msg: "OpenSSL instalado: {{ openssl_ver.stdout }}"

    - name: Instalar dependências para compilação
      package:
        name:
          - gcc
          - make
          - wget
          - tar
          - pam-devel
          - zlib-devel
          - which
        state: present

    - name: Criar diretório para código-fonte
      file:
        path: "{{ src_dir }}"
        state: directory
        mode: '0755'

    - name: Baixar código-fonte do OpenSSH
      get_url:
        url: "{{ openssh_url }}"
        dest: "{{ src_dir }}/openssh-{{ openssh_version }}.tar.gz"
        mode: '0644'

    - name: Extrair código-fonte
      unarchive:
        src: "{{ src_dir }}/openssh-{{ openssh_version }}.tar.gz"
        dest: "{{ src_dir }}"
        remote_src: yes

    - name: Rodar configure apontando para openssl compat
      shell: |
        ./configure --prefix=/usr --sysconfdir=/etc/ssh --with-pam CPPFLAGS=-I/usr/include/openssl-compat LDFLAGS=-L/usr/lib64/openssl-compat
      args:
        chdir: "{{ build_dir }}"
        creates: "{{ build_dir }}/Makefile"

    - name: Compilar OpenSSH
      shell: make -j$(nproc)
      args:
        chdir: "{{ build_dir }}"
        creates: "{{ build_dir }}/ssh"

    - name: Fazer backup dos binários originais
      shell: |
        cp /usr/bin/ssh /usr/bin/ssh.bkp || true
        cp /usr/sbin/sshd /usr/sbin/sshd.bkp || true

    - name: Instalar binários compilados (forçado)
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: '0755'
      loop:
        - { src: "{{ build_dir }}/ssh", dest: "/usr/bin/ssh" }
        - { src: "{{ build_dir }}/sshd", dest: "/usr/sbin/sshd" }

    - name: Corrigir permissões das chaves privadas do host
      file:
        path: "{{ item }}"
        mode: '0600'
        owner: root
        group: root
      loop:
        - /etc/ssh/ssh_host_rsa_key
        - /etc/ssh/ssh_host_ecdsa_key
        - /etc/ssh/ssh_host_ed25519_key
      ignore_errors: true

    - name: Validar configuração do sshd
      shell: /usr/sbin/sshd -t
      register: sshd_check
      failed_when: sshd_check.rc != 0
      changed_when: false

    - name: Reiniciar sshd se configuração OK
      systemd:
        name: sshd
        state: restarted
        enabled: true
      when: sshd_check.rc == 0

    - name: Verificar versão final do ssh
      command: ssh -V
      register: ssh_version
      changed_when: false

    - name: Exibir versão instalada
      debug:
        msg: "Versão do OpenSSH instalada: {{ ssh_version.stderr | default(ssh_version.stdout) }}"
