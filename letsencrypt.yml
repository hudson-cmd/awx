- name: Gerar e aplicar certificado Let's Encrypt no Asterisk
  hosts: all
  become: yes
  vars:
    dominio_base: ".com.br"
    lets_dir: "/etc/letsencrypt"
    asterisk_http_conf: "/etc/asterisk/http.conf"
    asterisk_pjsip_conf: "/etc/asterisk/pjsip_transport.conf"
    cert_email: "certificados@uniontelecom.com.br"

  tasks:
    - name: Instalar dependências necessárias
      dnf:
        name:
          - epel-release
          - certbot
          - python3-certbot-nginx
        state: present

    - name: Definir domínio baseado no hostname (minúsculo)
      set_fact:
        dominio: "{{ (ansible_hostname | replace('-', '.')) | lower }}{{ dominio_base }}"

    - name: Gerar certificado Let's Encrypt com Nginx
      command: >
        certbot --nginx
        -d {{ dominio }}
        --email {{ cert_email }}
        --agree-tos
        --non-interactive
      args:
        creates: "{{ lets_dir }}/live/{{ dominio }}/fullchain.pem"

    - name: Ajustar permissões da pasta Let's Encrypt
      file:
        path: "{{ lets_dir }}"
        owner: uscall
        group: uscall
        recurse: yes

    # --- Atualização do http.conf ---
    - name: Atualizar caminho do certificado no http.conf
      lineinfile:
        path: "{{ asterisk_http_conf }}"
        regexp: '^tlscertfile='
        line: "tlscertfile={{ lets_dir }}/live/{{ dominio }}/fullchain.pem"
        backup: yes

    - name: Atualizar caminho da chave no http.conf
      lineinfile:
        path: "{{ asterisk_http_conf }}"
        regexp: '^tlsprivatekey='
        line: "tlsprivatekey={{ lets_dir }}/live/{{ dominio }}/privkey.pem"

    # --- Atualização do pjsip_transport.conf ---
    - name: Atualizar cert_file em [tls]
      replace:
        path: "{{ asterisk_pjsip_conf }}"
        regexp: '(^\[tls\][\s\S]*?cert_file=).*'
        replace: "\\1{{ lets_dir }}/live/{{ dominio }}/fullchain.pem"
        backup: yes

    - name: Atualizar priv_key_file em [tls]
      replace:
        path: "{{ asterisk_pjsip_conf }}"
        regexp: '(^\[tls\][\s\S]*?priv_key_file=).*'
        replace: "\\1{{ lets_dir }}/live/{{ dominio }}/privkey.pem"

    - name: Atualizar cert_file em [tls6]
      replace:
        path: "{{ asterisk_pjsip_conf }}"
        regexp: '(^\[tls6\][\s\S]*?cert_file=).*'
        replace: "\\1{{ lets_dir }}/live/{{ dominio }}/fullchain.pem"

    - name: Atualizar priv_key_file em [tls6]
      replace:
        path: "{{ asterisk_pjsip_conf }}"
        regexp: '(^\[tls6\][\s\S]*?priv_key_file=).*'
        replace: "\\1{{ lets_dir }}/live/{{ dominio }}/privkey.pem"

    # --- Renovação automática via cron ---
    - name: Configurar cron para renovação automática
      cron:
        name: "Renovar certificados Let's Encrypt"
        job: "certbot renew --quiet && systemctl reload nginx && systemctl restart asterisk"
        hour: 3
        minute: 0
        user: root

    # --- Reiniciar Asterisk ---
    - name: Reiniciar Asterisk
      service:
        name: asterisk
        state: restarted
